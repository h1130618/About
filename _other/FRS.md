作品名稱：
# 基於Roblox引擎之鐵路模擬器系統開發

## 作者:二年己班 吳宇綸

### 關鍵字：鐵道模擬器、跨領域應用、專案管理、自主學習

## 摘要

本研究主要使用Roblox引擎，Roblox 是一個開放式 3D 模擬平台，我將它當成實驗場來實作電腦模擬與控制系統。論文內容粗略分為號誌系統、列車移動、列車系統，其中包括演算法、資料結構、物件導向、物理、數學等多種領域應用及整合。未來可以在此基礎上加入新的實驗性系統，如移動式閉塞，進一步增強台灣在鐵路系統發展及鐵路運輸效率。

## 壹、研究動機
我自幼對鐵道運輸領域有極大的興趣，因緣際會之下加入了「福爾摩沙鐵道模擬器」開發團隊，可以充分展現我自己在程式設計方面的知識，也跟我的目標校系有高度相關，可以增加我在資訊/電機工程方面的實作經驗，將台灣鐵路公司(以下簡稱台鐵)的部份系統以數位方式重現。從最基本的列車移動開始，延伸到列車其他系統，如車門、目的地顯示板，自動列車防護系統（ATP），再到鐵路號誌系統。以自主學習的方式，查詢Roblox官方文件、各種鐵路系統運作方式，更利用AI學習更深入的內容。雖然Roblox是一款遊戲引擎，但是我融入了多種領域的整合與應用，使其意義不只是一款遊戲，而是一個小型的運輸模擬平台。
## 貳、研究目的
本研究主要是進行鐵路模擬器開發，利用Roblox引擎，從零開始自行開發各種相關系統，自行控制資料傳輸、客戶端模型處理。詳細研究目的如下
一、路徑設定及自動化軌道鋪設
二、基於物理計算列車位置及速度，使移動方式更貼近現實情況
三、列車各項系統，讓使用者可以操控，且可以正確的顯示在所有客戶端上
四、開發號誌系統，增加模擬的真實性


## 參、引擎介紹
本研究使用的是Roblox遊戲引擎，本身具備非常完善的開發環境，許多如資料傳輸、3D渲染等底層邏輯都已經包含在內，可以讓我們更專注於本研究的主要內容，支持實時多人共編、多人測試，且有強大的社群，內含非常多免費的實用資源可以直接使用對於沒有太多經驗的開發者很友好，而且在遊戲發布後，我們也不用自己管理伺服器，全部交由Robloxt處理。該引擎使用的是luau語言，優點是簡潔輕量，但內建的資料結構甚至不如Python完善，所以很多如類別(class)、堆疊(stack)等等都要自己從頭建構，不過其內建的table類別自由度非常高，在一定程度上彌補了這一缺失。

## 肆、研究過程與方法
### 一、列車軌道、路徑設定
1. 內建物理系統
我們一開始是直接在路線兩側放置方塊作為導軌，要讓列車移動也非常簡單，利用Roblox內建的BodyVelocity物件，他可以對物件施予一個力去達到指定的速度，再於鋼輪模型旁邊加上一個球形物件當作導輪，讓他與導軌物件碰撞，使列車可以照著軌道移動。上述這種方法固然方便，也是目前市面上大多鐵路模擬器運用的方法，但這有個致命的缺點就是容易出軌，就算是不超速正常行駛也會莫名其妙脫離軌道，當然有些模擬器有找到方法，但我們討論了一下覺得時間成本及其成效不高。

2. 基於數學計算
最後我們決定採用這種方法：自己設定運行軌跡讓列車照著跑，利用數學計算出列車所在位置方向，也是目前出名的鐵道模擬器所用的系統。
	在路徑儲存與表示這裏我們也有兩種方法:貝茲曲線(Bézier curve)和用長條方塊物件表示，貝茲曲線最大的優點就是可以使轉彎處看起來更平滑，但是Roblox並沒有內建相關工具，這樣使我們要從頭開始建立一個貝茲曲線模組變成極度困難，而且依照我之前在Unreal引擎使用貝茲曲線的經驗，在總位移高到一個程度時，執行位移會出現誤差導致車廂之間會呈現不正常的前後相對移動和碰撞。方塊物件就是將曲線簡化成多段直線，也就可以很好的解決這個問題，雖然在線段跟線段之間會因為有夾角而讓列車產生不自然的瞬間轉向，但對於一個非專業的模擬器，綜合效能、效果考量這是最好的解法，也可以比較可視化的方式成呈現出路徑，方便地圖建造人員作業。
我們的做法是先在路徑上建立長條形的方塊物件，如下圖一
▲圖一:以方塊物件表示路徑(資料來源：遊戲內拍攝)
	路徑出來之後軌道模型就很簡單了，只需要用插件在路徑的兩側特定距離放置鋼軌並調整長度，再每隔一段距離放置枕木，鋼軌長度在轉彎處會需要用三角函數進行微調，否則會因為內外圈的半徑差導致斷軌，至此本段完結，成品如下圖二，接下來的挑戰便是如何讓列車以符合物理邏輯的情況下移動。
▲圖二:軌道及枕木擺放(資料來源：遊戲內拍攝)

### 二、列車移動
1. 列車定位
這並不只是將列車整列移動到路徑上的某個點，而是要各自計算每一節車廂對應的位置及方向，但是列車的輪子都是裝在一個特殊構造稱作轉向架(Bogie)上，所以我也要計算前後轉向架各自的位置及方向，流程圖如下圖三。

▲圖三:車體位置更新流程(資料來源：自行繪製)
計算位置的部分Roblox中有提供一個非常好的座標系統CFrame，全稱是Coordination Frame，利用四階方陣儲存物件的位置及旋轉方向，同時也可以當變換矩陣，可以簡單的利用*或是+等操作去實現物件移動和轉動，不同於學校教的二維變換矩陣，這裡要將原矩陣當作被乘矩陣，搭配三維向量資料型態Vector3，就可以完成所有列車定位的操作，這部分需要我熟悉向量運算、內積/外積關係，並將其轉化為程式中的 CFrame 資料結構。雖然平台本身提供基本函式，但如何將數學模型正確映射到模擬環境，仍需自行推導與驗證。


2. 列車位移更新
這個部分要運用到高中物理所學的運動學，首先去維基百科查詢該列車的動力資訊，以電力機車E500為例，其最高輸出功率為3888KW，整備重量為96公噸，由功率公式$P= \dfrac{FS}{t}=Fv$可得知在速度為$v$的情況下，馬達最大出力可達$3888/v$KN
由於鋼與鋼之間的摩擦係數偏低(約0.2)，由摩擦力公式$f= \mu_s N$可知起步時出力若超過$96000 \times 9.8 \times 0.2=188160N$就會打滑，使出力減到剩$96000 \times 9.8 \times 0.1=94080N$，這就是單節車廂的出力
至於其他外力，主要是行駛時的阻力和在斜坡上的下滑力，行駛阻力的部分詢問ChatGPT，且經查證後決定考慮滾動阻力和空氣阻力兩個因素，根據滾動阻力$f=C_{rr}N$和空氣阻力$f= \dfrac{1}{2} \rho v^2 C_d A$，合併成阻力公式，而下滑力就是$F=mgsin \theta$
將這幾項合起來就是一節車廂的合力，得到整列的合力除以整列質量就是加速度，進而求出速度差值$dv=a \cdot dt$，再去更新列車位置$dx=v \cdot dt$。

3. 車廂晃動
單純按照理論移動車子會忽略掉軌道上的那些干擾因素，例如軌道鋪設不良、駛過軌道接縫處或岔路等，因此我們決定加上列車的晃動，使模擬看起來更真實。經過長期搭車時的觀察，列車晃動大致上可以分成X軸上的微幅轉動和Y軸的上下震動，雖然這些震動是隨機的，但遊戲內將其作成週期性運動就可以達到極高的成效，而這種運動就是物理學到的簡諧運動(SHM)，利用$cos$搭配上設定好的震幅、週期，再定義一個隨機的初始角度便可以用簡諧公式$x=Rcos( \omega t+ \theta)$實現。


### 三、列車功能
#### （一）列車物件
列車本質上是一群互相獨立且性質高度相似的物件，每個物件當中又包含大量的變數、函式，這個性質就非常適合使用物件導向(Object Oriented Programming, OOP)的概念去實作，可以讓我更容易去撰寫和維護這部分的程式。
Roblox所使用的luau語言並沒有如`Python`、 `C++`等程式語言有內建專門的OOP語法，而是要自己建立一個metatable物件，這很類似python中的字典(Dictionary)，可以儲存各種資料型態，也就是說裡面可以儲存各種變數和函式用來實現建立類別(Class)。
而在luau中呼叫函式的語法跟`python`、`C++`略有不同，如果是`class.function()`就不會將該類別本身傳進去參數，要使用`class:function()`才可以在函數內呼叫`self`，這點讓我在剛開始使用時花了不少時間去debug。

#### (二)駕駛艙
既然是鐵道模擬遊戲，就必須要讓玩家可以駕駛列車，而在我的設計中，駕駛艙物件扮演的角色是伺服器跟玩家之間的橋樑，當玩家發送一個請求(例如:切換前進/後退、增加電門段位)，駕駛艙物件負責接受請求並更改列車物件上的對應資料，讓操作能體現在列車上，同時也通知其他的駕駛艙，讓整列車上的所有駕駛艙實現連動。
#### (三)資料傳輸
由於我們最一開始嘗試過將所有資料儲存在伺服端，每個tick由伺服端計算完列車位置及其他各種外觀屬性(例如車門開/關、目的地顯示器)後，再透過Roblox內建的串流(stream)將資料傳到客戶端手上，最後進行渲染，這種方式我們只需要控制再伺服端上進行運算，其他一律交給引擎處理，不過由於現實中網路並不如我們想像中的穩定，這就會造成模擬出來的車輛有明顯的卡頓，效果明顯不佳。
為了解決這一問題，我們改成再伺服端上計算出列車位移和處理其他外觀屬性，並且將所有車輛的所有資料包成一個table傳給客戶端。客戶端利用for迴圈處理每一節列車的資料，如果與客戶端的距離小於某個閥值，就複製列車模型並開始處理資料、計算位置並定位，最後再進行渲染。在客戶端上還可以根據得到的加速度及速度利用運動學公式進行推演，將網路延遲不穩定的影
降到最低。但是這樣我們要撰寫的程式、邏輯數量和複雜程度會大幅度提升，但是得出的結果確實讓我們非常滿意。

### 四、號誌系統
#### （一）系統介紹
站間的路段若沒有岔路，路線很單純、簡單，所以我們可以採用的是台鐵現行的**自動閉塞系統**，軌道會被分為多個不同的閉塞區間(Block)，其核心概念每個區塊只能同時容許一列車在內，進而延伸出號誌機讓駕駛員可以判斷前方的區間是否安全，若前方區間有車，則信號機為紅燈，若正前方是空的但再往前一個區間，則顯示黃燈，否則為綠燈。
而站內因為通常有岔路，使路線變得格外複雜，已非自動閉塞系統所能勝任，需要人工介入設定路線，讓列車可以到達指定的月台。目前台鐵系統只需要調度員選擇路線起點與終點，系統會尋找最佳路線，並且確定無與其他列車碰撞的風險，才可以建立路線並將信號機設定為綠燈。
#### （二）系統設計概念
1. 自動閉塞號誌
我們將閉塞區間包成一個類別，當中包括信號機的類別，他負責檢測區間中是否有列車行駛。若有列車進入區間則將信號機設為紅燈。當信號機的狀態被改變時，也會呼叫相鄰的信號機的函式去改變狀態，進入一個遞迴，觸發一個連鎖反應，我將紅、黃、綠分別編號為0、1、2，一個類似狀態機(state machine)的概念，這樣我在呼叫外圍的信號機時只需要將當前的狀態+1。
舉個例子，我將五個閉塞區間分別命名為A1~A5，當列車從A2進到A1時，A1的信號機需設為紅燈(0)，列車仍有部分在A2內，A2的信號機仍為紅燈，其他也不需變更。當列車完全進入A1，A2的信號機則設為黃燈(1)，進入遞迴向後更新A3為1+1=2(綠)。
在這個情況下只有三種信號的狀態，使用狀態機顯得有點多餘，但這樣好處就是非常容易擴充、容易更改其他屬性（燈號）、不容易出錯（例如"Green"可能拼錯），而且不用為了每種信號狀態寫一個判斷式去向外遞迴更新。
2. 站內號誌控制
上述系統雖然簡單、安全，但它無法直接利用在有岔路的鐵路區間，這部分就需要行車控制中心（Operation Control Center,OCC）或是車站內部的人員去控制岔路。
既然是選擇起點終點後自動搜尋路線，那麼就需要用到尋路演算法，比較經典的像是BFS,DFS,Dijkstra's，而如果要最佳化路線，主要的因素是軌道的平直程度，軌道越直，列車能通過速率上限就越高，對營運的影響相對就少。而要讓路線直，在岔路就要盡量選擇直線的那側，所以我選擇DFS並將其做一點改良。
當號誌員要建立路線時，程式會去尋找起和終點的軌道，而軌道一樣是將其包成一個oop物件，其中包含兩側接的軌道，有各有直走與轉彎（可有可無），在搜尋時會優先處理直走的軌道，若遞迴中找到可行路線就直接返回，此路線可能並非最佳，但是也可以達到差不多的效果且效率很高。

## 伍、研究結果與討論
經過對以上提到的部分進行撰寫及整合後，模擬器已經初具雛形，在玩家高強度測試後依然維持一定的穩定性，尤其是在網路連線狀況不佳的環境下仍然可以順暢地模擬。
伺服器可以接收玩家輸入的操作，並對於對應的變數做出修改，再根據這些數據套入物理公式做出動力模擬，計算出推力、摩擦力、下滑力，推出加速度、速度及位移，最後將數據傳給客戶端，客戶端再根據這些數據進行列車定位及渲染。
號誌系統的部分，當列車進入一個閉塞區間，控制盤會顯示其位置，方便調度員做出決定，相鄰的號誌機也會做出相應的變化，以便其他駕駛員得知前方區間是否安全。站內建立路線時，調度員選擇起點及終點後，程式能夠自動跑出合適的路徑，顯示於調度盤上，並且改變號誌，示意駕駛員可以進入站場區域。
在我們測試中，有時會發生例如三節車廂留在原地，一節車箱自己往前行駛的狀況，最初我們無法在程式碼中找出問題，到最後我們將列車外觀模型拿掉，只剩下運行必須的物件，列車就可以順利運行不會出錯，目前推測問題主要是因為列車模型的三角形數過多，造成模擬器引擎渲染錯誤，也就是需要建模師優化模型。

## 陸、結論
本研究所開發的模擬器，並不只是一款遊戲那麼簡單，以下是我們想到的未來展望
一、運輸模擬
本模擬器具備了大部分常見的鐵路設施（信號、車門、駕駛控制系統），未來如果要模擬列車運行，例如用於時刻表編排，也可以用於研發新的信號或列車防護系統，例如移動式閉塞號誌，可以有效率的增加幹線上的列車運行效率。
二、人員訓練
我們未來可以加入更多列車系統，可以讓在職人員使用，作為駕駛員、列車長和站務員的人員培訓。在模擬器上先跑過幾次可以讓人員在實習時更快的進入狀況。

經過這陣子的開發經歷，我除了表面上的演算法跟系統整合能力提升，我還增進了不少關於多人協作專案的各種經驗，也將一些學校教的知識拿來活用，做出更真實的運行。未來希望可以進入電資相關科系去學習更多相關技能，甚至加入人工智慧等技術，使我可以更好進入業界工作。
